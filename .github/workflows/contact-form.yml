name: Contact Form Submission

on:
  repository_dispatch:
    types: [contact-form-submission]

jobs:
  process-submission:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: leads
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create leads directory if needed
        run: mkdir -p leads

      - name: Generate timestamp
        id: timestamp
        run: echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Save submission to JSON
        run: |
          FILENAME="leads/$(date -u +%Y-%m-%d_%H-%M-%S)_${{ github.event.client_payload.email }}.json"
          jq -n \
            --arg timestamp "${{ steps.timestamp.outputs.timestamp }}" \
            --arg firstName "${{ github.event.client_payload.firstName }}" \
            --arg lastName "${{ github.event.client_payload.lastName }}" \
            --arg email "${{ github.event.client_payload.email }}" \
            --arg phone "${{ github.event.client_payload.phone }}" \
            --arg address "${{ github.event.client_payload.address }}" \
            --arg message "${{ github.event.client_payload.message }}" \
            '{
              timestamp: $timestamp,
              firstName: $firstName,
              lastName: $lastName,
              email: $email,
              phone: $phone,
              address: $address,
              message: $message
            }' > "$FILENAME"

      - name: Commit submission
        run: |
          git config user.name "Contact Form Bot"
          git config user.email "noreply@shaffercon.com"
          git add leads/
          git commit -m "ðŸ“¬ New contact from ${{ github.event.client_payload.firstName }} ${{ github.event.client_payload.lastName }} (${{ github.event.client_payload.email }})"
          git push origin leads
